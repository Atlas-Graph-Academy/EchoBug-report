<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#16213e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EchoBug">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>EchoBug Photo Reporter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --card: #0f3460;
      --accent: #e94560;
      --accent-hover: #ff6b81;
      --text: #eee;
      --text-dim: #8892b0;
      --radius: 14px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    /* ── Login screen ── */
    .login-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 24px;
      gap: 24px;
    }
    .login-logo {
      width: 80px;
      height: 80px;
      background: var(--accent);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-screen h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .login-screen p {
      font-size: 15px;
      color: var(--text-dim);
      line-height: 1.5;
      max-width: 300px;
    }
    .login-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      background: #5E6AD2;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s, background 0.2s;
      margin-top: 8px;
    }
    .login-btn:hover { background: #7078e6; }
    .login-btn:active { transform: scale(0.96); }
    .login-btn svg { flex-shrink: 0; }
    .login-error {
      color: var(--accent);
      font-size: 14px;
      max-width: 300px;
    }
    .login-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Header ── */
    header {
      background: var(--surface);
      padding: 16px 20px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-dim);
      overflow: hidden;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .user-name {
      font-size: 13px;
      color: var(--text-dim);
    }
    .logout-btn {
      background: none;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-dim);
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .logout-btn:hover { background: rgba(255,255,255,0.06); }
    .photo-count {
      font-size: 13px;
      color: var(--text-dim);
      background: rgba(255,255,255,0.07);
      padding: 4px 12px;
      border-radius: 20px;
    }

    /* ── Main ── */
    main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: calc(100px + var(--safe-bottom));
    }

    /* ── Empty state ── */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 60vh;
      gap: 16px;
      color: var(--text-dim);
    }
    .empty-state svg { opacity: 0.3; }
    .empty-state p { font-size: 15px; line-height: 1.5; max-width: 260px; }

    /* ── Photo grid ── */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    .photo-card {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface);
      aspect-ratio: 1;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .photo-card:active { transform: scale(0.97); }
    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .photo-card .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      border: none;
      color: #fff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .photo-card:hover .delete-btn,
    .photo-card:focus-within .delete-btn { opacity: 1; }
    @media (hover: none) {
      .photo-card .delete-btn { opacity: 1; }
    }

    /* ── Lightbox ── */
    .lightbox {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0,0,0,0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .lightbox.open { opacity: 1; pointer-events: auto; }
    .lightbox img {
      max-width: 95%;
      max-height: 90dvh;
      border-radius: 8px;
      object-fit: contain;
    }
    .lightbox-close {
      position: absolute;
      top: 16px;
      right: 16px;
      top: calc(env(safe-area-inset-top, 0px) + 16px);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.12);
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ── Bottom action bar ── */
    .action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      padding-bottom: calc(16px + var(--safe-bottom));
      background: linear-gradient(transparent, var(--bg) 30%);
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .action-btn {
      flex: 1;
      max-width: 180px;
      height: 52px;
      border: none;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.12s, background 0.2s;
    }
    .action-btn:active { transform: scale(0.95); }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary {
      background: var(--card);
      color: #fff;
    }
    .btn-secondary:hover { background: #1a4a8a; }

    /* Hidden file inputs */
    .hidden { display: none; }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: calc(90px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      z-index: 200;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>

  <!-- ══════ Login Screen ══════ -->
  <div class="login-screen" id="loginScreen">
    <div class="login-logo">
      <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="#fff" stroke-width="1.8">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
    </div>
    <h1>EchoBug</h1>
    <p>Photo reporter for your team. Log in with your Linear account to get started.</p>
    <button class="login-btn" id="btnLogin">
      <svg width="20" height="20" viewBox="0 0 100 100" fill="currentColor"><path d="M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm21.3 71.4H28.7V28.6h42.6v42.8z"/></svg>
      Log in with Linear
    </button>
    <div class="login-error hidden" id="loginError"></div>
  </div>

  <!-- ══════ App (hidden until logged in) ══════ -->
  <div id="appShell" class="hidden">
    <header>
      <div class="header-left">
        <h1>EchoBug</h1>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar"></div>
          <span class="user-name" id="userName"></span>
        </div>
        <span class="photo-count" id="photoCount">0 photos</span>
        <button class="logout-btn" id="btnLogout">Log out</button>
      </div>
    </header>

    <main id="mainArea">
      <div class="empty-state" id="emptyState">
        <svg width="80" height="80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.2">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
        <p>No photos yet.<br>Tap a button below to pick from your album or take a new photo.</p>
      </div>
      <div class="photo-grid hidden" id="photoGrid"></div>
    </main>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
      <button class="lightbox-close" id="lightboxClose">&times;</button>
      <img id="lightboxImg" src="" alt="Full preview">
    </div>

    <!-- Bottom bar -->
    <div class="action-bar">
      <button class="action-btn btn-secondary" id="btnAlbum">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
        Album
      </button>
      <button class="action-btn btn-primary" id="btnCamera">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Camera
      </button>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="albumInput" class="hidden" accept="image/*" multiple>
    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment">
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ╔══════════════════════════════════════════╗
    // ║  LINEAR OAUTH CONFIG                     ║
    // ║  Replace with your Linear OAuth Client ID ║
    // ╚══════════════════════════════════════════╝
    const LINEAR_CLIENT_ID = 'ac9bd5f9dd78f12627dba45ba35618eb';
    const REDIRECT_URI = 'http://bug.iditor.com';
    const LINEAR_SCOPES = 'read';
    const LINEAR_AUTH_URL = 'https://linear.app/oauth/authorize';
    const LINEAR_TOKEN_URL = 'https://api.linear.app/oauth/token';
    const LINEAR_GRAPHQL_URL = 'https://api.linear.app/graphql';

    // ── DOM refs ──
    const loginScreen = document.getElementById('loginScreen');
    const appShell = document.getElementById('appShell');
    const btnLogin = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');
    const btnLogout = document.getElementById('btnLogout');
    const userAvatar = document.getElementById('userAvatar');
    const userNameEl = document.getElementById('userName');
    const albumInput = document.getElementById('albumInput');
    const cameraInput = document.getElementById('cameraInput');
    const photoGrid = document.getElementById('photoGrid');
    const emptyState = document.getElementById('emptyState');
    const photoCount = document.getElementById('photoCount');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.getElementById('lightboxClose');
    const toast = document.getElementById('toast');

    // ══════════════════════════════════════
    //  PKCE helpers
    // ══════════════════════════════════════
    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      const values = crypto.getRandomValues(new Uint8Array(length));
      return Array.from(values, (v) => chars[v % chars.length]).join('');
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return crypto.subtle.digest('SHA-256', data);
    }

    function base64UrlEncode(arrayBuffer) {
      const bytes = new Uint8Array(arrayBuffer);
      let str = '';
      bytes.forEach((b) => str += String.fromCharCode(b));
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function generatePKCE() {
      const verifier = generateRandomString(64);
      const hashed = await sha256(verifier);
      const challenge = base64UrlEncode(hashed);
      return { verifier, challenge };
    }

    // ══════════════════════════════════════
    //  Auth state
    // ══════════════════════════════════════
    function getTokens() {
      const raw = localStorage.getItem('echobug_tokens');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function saveTokens(tokens) {
      tokens.saved_at = Date.now();
      localStorage.setItem('echobug_tokens', JSON.stringify(tokens));
    }

    function clearTokens() {
      localStorage.removeItem('echobug_tokens');
      localStorage.removeItem('echobug_user');
    }

    function getUser() {
      const raw = localStorage.getItem('echobug_user');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function saveUser(user) {
      localStorage.setItem('echobug_user', JSON.stringify(user));
    }

    function isTokenExpired(tokens) {
      if (!tokens || !tokens.saved_at || !tokens.expires_in) return true;
      const expiresAt = tokens.saved_at + (tokens.expires_in * 1000);
      return Date.now() > expiresAt - 60000; // 1 min buffer
    }

    // ══════════════════════════════════════
    //  OAuth flow
    // ══════════════════════════════════════
    async function startLogin() {
      const { verifier, challenge } = await generatePKCE();
      const state = generateRandomString(32);

      sessionStorage.setItem('pkce_verifier', verifier);
      sessionStorage.setItem('oauth_state', state);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: LINEAR_CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: LINEAR_SCOPES,
        state: state,
        code_challenge: challenge,
        code_challenge_method: 'S256',
        prompt: 'consent'
      });

      window.location.href = `${LINEAR_AUTH_URL}?${params}`;
    }

    async function exchangeCode(code) {
      const verifier = sessionStorage.getItem('pkce_verifier');
      if (!verifier) throw new Error('Missing PKCE verifier');

      const res = await fetch(LINEAR_TOKEN_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: REDIRECT_URI,
          client_id: LINEAR_CLIENT_ID,
          code_verifier: verifier
        })
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Token exchange failed: ${err}`);
      }

      const tokens = await res.json();
      sessionStorage.removeItem('pkce_verifier');
      sessionStorage.removeItem('oauth_state');
      return tokens;
    }

    async function refreshAccessToken(tokens) {
      const res = await fetch(LINEAR_TOKEN_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: tokens.refresh_token,
          client_id: LINEAR_CLIENT_ID
        })
      });

      if (!res.ok) throw new Error('Token refresh failed');
      return await res.json();
    }

    async function fetchLinearUser(accessToken) {
      const res = await fetch(LINEAR_GRAPHQL_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({
          query: '{ viewer { id name email displayName avatarUrl } }'
        })
      });

      if (!res.ok) throw new Error('Failed to fetch user');
      const json = await res.json();
      return json.data.viewer;
    }

    // ══════════════════════════════════════
    //  UI switching
    // ══════════════════════════════════════
    function showLogin(errorMsg) {
      loginScreen.classList.remove('hidden');
      appShell.classList.add('hidden');
      btnLogin.disabled = false;
      btnLogin.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 100 100" fill="currentColor"><path d="M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm21.3 71.4H28.7V28.6h42.6v42.8z"/></svg>
        Log in with Linear`;
      if (errorMsg) {
        loginError.textContent = errorMsg;
        loginError.classList.remove('hidden');
      } else {
        loginError.classList.add('hidden');
      }
    }

    function showApp(user) {
      loginScreen.classList.add('hidden');
      appShell.classList.remove('hidden');

      const name = user.displayName || user.name || user.email || 'User';
      userNameEl.textContent = name;

      if (user.avatarUrl) {
        userAvatar.innerHTML = `<img src="${user.avatarUrl}" alt="${name}">`;
      } else {
        userAvatar.textContent = name.charAt(0).toUpperCase();
      }
    }

    function showLoginLoading() {
      btnLogin.disabled = true;
      btnLogin.innerHTML = '<div class="login-spinner"></div> Logging in...';
    }

    // ══════════════════════════════════════
    //  IndexedDB
    // ══════════════════════════════════════
    const DB_NAME = 'echobug-photos';
    const STORE_NAME = 'photos';
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          }
        };
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e.target.error);
      });
    }

    function dbAdd(record) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const req = store.add(record);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function dbGetAll() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function dbDelete(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const req = store.delete(id);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    // ══════════════════════════════════════
    //  Photo UI
    // ══════════════════════════════════════
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function updateCount(n) {
      photoCount.textContent = `${n} photo${n !== 1 ? 's' : ''}`;
    }

    function toggleEmpty(photoList) {
      if (photoList.length === 0) {
        emptyState.classList.remove('hidden');
        photoGrid.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        photoGrid.classList.remove('hidden');
      }
      updateCount(photoList.length);
    }

    function createPhotoCard(photo) {
      const card = document.createElement('div');
      card.className = 'photo-card';
      card.dataset.id = photo.id;

      const img = document.createElement('img');
      img.src = photo.dataUrl;
      img.alt = photo.name || 'Photo';
      img.loading = 'lazy';

      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.innerHTML = '&times;';
      del.title = 'Remove';
      del.addEventListener('click', async (e) => {
        e.stopPropagation();
        await dbDelete(photo.id);
        card.remove();
        const remaining = photoGrid.querySelectorAll('.photo-card');
        toggleEmpty(remaining);
        showToast('Photo removed');
      });

      card.addEventListener('click', () => {
        lightboxImg.src = photo.dataUrl;
        lightbox.classList.add('open');
      });

      card.appendChild(img);
      card.appendChild(del);
      return card;
    }

    async function renderAll() {
      const photos = await dbGetAll();
      photoGrid.innerHTML = '';
      photos.forEach((p) => photoGrid.appendChild(createPhotoCard(p)));
      toggleEmpty(photos);
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    async function handleFiles(files) {
      let added = 0;
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const record = { name: file.name, dataUrl, createdAt: Date.now() };
        const id = await dbAdd(record);
        record.id = id;
        photoGrid.appendChild(createPhotoCard(record));
        added++;
      }
      if (added > 0) {
        const all = photoGrid.querySelectorAll('.photo-card');
        toggleEmpty(all);
        showToast(`${added} photo${added > 1 ? 's' : ''} added`);
      }
    }

    // ══════════════════════════════════════
    //  Event listeners
    // ══════════════════════════════════════
    btnLogin.addEventListener('click', startLogin);

    btnLogout.addEventListener('click', () => {
      clearTokens();
      showLogin();
    });

    document.getElementById('btnAlbum').addEventListener('click', () => albumInput.click());
    document.getElementById('btnCamera').addEventListener('click', () => cameraInput.click());

    albumInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleFiles(e.target.files);
      e.target.value = '';
    });

    cameraInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleFiles(e.target.files);
      e.target.value = '';
    });

    lightboxClose.addEventListener('click', () => lightbox.classList.remove('open'));
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) lightbox.classList.remove('open');
    });

    // ══════════════════════════════════════
    //  Init
    // ══════════════════════════════════════
    (async () => {
      db = await openDB();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      }

      // Check for OAuth callback (?code=...&state=...)
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const returnedState = params.get('state');

      if (code) {
        // Clean URL immediately
        window.history.replaceState({}, '', window.location.pathname);

        const savedState = sessionStorage.getItem('oauth_state');
        if (returnedState !== savedState) {
          showLogin('Login failed: state mismatch. Please try again.');
          return;
        }

        showLoginLoading();
        try {
          const tokens = await exchangeCode(code);
          saveTokens(tokens);
          const user = await fetchLinearUser(tokens.access_token);
          saveUser(user);
          showApp(user);
          await renderAll();
        } catch (err) {
          console.error('OAuth error:', err);
          showLogin('Login failed. Please try again.');
        }
        return;
      }

      // Check for error callback
      if (params.get('error')) {
        window.history.replaceState({}, '', window.location.pathname);
        showLogin(`Login denied: ${params.get('error_description') || params.get('error')}`);
        return;
      }

      // Check for existing session
      const tokens = getTokens();
      if (tokens) {
        try {
          let activeTokens = tokens;

          if (isTokenExpired(tokens)) {
            if (tokens.refresh_token) {
              activeTokens = await refreshAccessToken(tokens);
              saveTokens(activeTokens);
            } else {
              clearTokens();
              showLogin('Session expired. Please log in again.');
              return;
            }
          }

          // Try fetching user to validate the token
          const user = await fetchLinearUser(activeTokens.access_token);
          saveUser(user);
          showApp(user);
          await renderAll();
        } catch {
          clearTokens();
          showLogin('Session expired. Please log in again.');
        }
        return;
      }

      // No session — show login
      showLogin();
    })();
  </script>
</body>
</html>
