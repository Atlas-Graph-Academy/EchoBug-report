<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#16213e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EchoBug">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>EchoBug Photo Reporter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --card: #0f3460;
      --accent: #e94560;
      --accent-hover: #ff6b81;
      --text: #eee;
      --text-dim: #8892b0;
      --radius: 14px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    /* ── Header ── */
    header {
      background: var(--surface);
      padding: 16px 20px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    .photo-count {
      font-size: 13px;
      color: var(--text-dim);
      background: rgba(255,255,255,0.07);
      padding: 4px 12px;
      border-radius: 20px;
    }

    /* ── Main ── */
    main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: calc(100px + var(--safe-bottom));
    }

    /* ── Empty state ── */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 60vh;
      gap: 16px;
      color: var(--text-dim);
    }
    .empty-state svg { opacity: 0.3; }
    .empty-state p { font-size: 15px; line-height: 1.5; max-width: 260px; }

    /* ── Photo grid ── */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    .photo-card {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface);
      aspect-ratio: 1;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .photo-card:active { transform: scale(0.97); }
    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .photo-card .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      border: none;
      color: #fff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .photo-card:hover .delete-btn,
    .photo-card:focus-within .delete-btn { opacity: 1; }
    @media (hover: none) {
      .photo-card .delete-btn { opacity: 1; }
    }

    /* ── Lightbox ── */
    .lightbox {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0,0,0,0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .lightbox.open { opacity: 1; pointer-events: auto; }
    .lightbox img {
      max-width: 95%;
      max-height: 90dvh;
      border-radius: 8px;
      object-fit: contain;
    }
    .lightbox-close {
      position: absolute;
      top: 16px;
      right: 16px;
      top: calc(env(safe-area-inset-top, 0px) + 16px);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.12);
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ── Bottom action bar ── */
    .action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      padding-bottom: calc(16px + var(--safe-bottom));
      background: linear-gradient(transparent, var(--bg) 30%);
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .action-btn {
      flex: 1;
      max-width: 180px;
      height: 52px;
      border: none;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.12s, background 0.2s;
    }
    .action-btn:active { transform: scale(0.95); }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary {
      background: var(--card);
      color: var(--text);
    }
    .btn-secondary:hover { background: #1a4a8a; }

    /* Hidden file inputs */
    .hidden { display: none; }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: calc(90px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      z-index: 200;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>

  <header>
    <h1>EchoBug</h1>
    <span class="photo-count" id="photoCount">0 photos</span>
  </header>

  <main id="mainArea">
    <div class="empty-state" id="emptyState">
      <svg width="80" height="80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.2">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
      <p>No photos yet.<br>Tap a button below to pick from your album or take a new photo.</p>
    </div>
    <div class="photo-grid hidden" id="photoGrid"></div>
  </main>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <button class="lightbox-close" id="lightboxClose">&times;</button>
    <img id="lightboxImg" src="" alt="Full preview">
  </div>

  <!-- Bottom bar -->
  <div class="action-bar">
    <button class="action-btn btn-secondary" id="btnAlbum">
      <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
      Album
    </button>
    <button class="action-btn btn-primary" id="btnCamera">
      <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
      Camera
    </button>
  </div>

  <!-- Hidden file inputs -->
  <input type="file" id="albumInput" class="hidden" accept="image/*" multiple>
  <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment">

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const albumInput = document.getElementById('albumInput');
    const cameraInput = document.getElementById('cameraInput');
    const photoGrid = document.getElementById('photoGrid');
    const emptyState = document.getElementById('emptyState');
    const photoCount = document.getElementById('photoCount');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.getElementById('lightboxClose');
    const toast = document.getElementById('toast');

    const DB_NAME = 'echobug-photos';
    const STORE_NAME = 'photos';
    let db;

    // ── IndexedDB setup ──
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          }
        };
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e.target.error);
      });
    }

    function dbAdd(record) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const req = store.add(record);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function dbGetAll() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function dbDelete(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const req = store.delete(id);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }

    // ── UI helpers ──
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function updateCount(n) {
      photoCount.textContent = `${n} photo${n !== 1 ? 's' : ''}`;
    }

    function toggleEmpty(photoList) {
      if (photoList.length === 0) {
        emptyState.classList.remove('hidden');
        photoGrid.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        photoGrid.classList.remove('hidden');
      }
      updateCount(photoList.length);
    }

    function createPhotoCard(photo) {
      const card = document.createElement('div');
      card.className = 'photo-card';
      card.dataset.id = photo.id;

      const img = document.createElement('img');
      img.src = photo.dataUrl;
      img.alt = photo.name || 'Photo';
      img.loading = 'lazy';

      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.innerHTML = '&times;';
      del.title = 'Remove';
      del.addEventListener('click', async (e) => {
        e.stopPropagation();
        await dbDelete(photo.id);
        card.remove();
        const remaining = photoGrid.querySelectorAll('.photo-card');
        toggleEmpty(remaining);
        showToast('Photo removed');
      });

      card.addEventListener('click', () => {
        lightboxImg.src = photo.dataUrl;
        lightbox.classList.add('open');
      });

      card.appendChild(img);
      card.appendChild(del);
      return card;
    }

    async function renderAll() {
      const photos = await dbGetAll();
      photoGrid.innerHTML = '';
      photos.forEach((p) => photoGrid.appendChild(createPhotoCard(p)));
      toggleEmpty(photos);
    }

    // ── Read files as dataURL ──
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    async function handleFiles(files) {
      let added = 0;
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const record = { name: file.name, dataUrl, createdAt: Date.now() };
        const id = await dbAdd(record);
        record.id = id;
        photoGrid.appendChild(createPhotoCard(record));
        added++;
      }
      if (added > 0) {
        const all = photoGrid.querySelectorAll('.photo-card');
        toggleEmpty(all);
        showToast(`${added} photo${added > 1 ? 's' : ''} added`);
      }
    }

    // ── Events ──
    document.getElementById('btnAlbum').addEventListener('click', () => albumInput.click());
    document.getElementById('btnCamera').addEventListener('click', () => cameraInput.click());

    albumInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleFiles(e.target.files);
      e.target.value = '';
    });

    cameraInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleFiles(e.target.files);
      e.target.value = '';
    });

    lightboxClose.addEventListener('click', () => lightbox.classList.remove('open'));
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) lightbox.classList.remove('open');
    });

    // ── Init ──
    (async () => {
      db = await openDB();
      await renderAll();

      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      }
    })();
  </script>
</body>
</html>
